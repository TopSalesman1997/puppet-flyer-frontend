{"version":3,"file":"script.bundle.js","sources":["../../src/script.js"],"sourcesContent":["// script.js - Leaderboard and Player Stats functionality\r\n// Uses Firestore helpers exported from firebase-client.js on window.fbFs\r\n\r\n// ---------- Shared helpers ----------\r\n\r\nfunction getDb() {\r\n  const db = window.fbDb;\r\n  if (!db) {\r\n    throw new Error(\"Firestore (window.fbDb) not initialized. \" +\r\n      \"Make sure firebase-client.js runs before script.js.\");\r\n  }\r\n  return db;\r\n}\r\n\r\nfunction getAuthInstance() {\r\n  const auth = window.fbAuth;\r\n  if (!auth) {\r\n    throw new Error(\"Auth (window.fbAuth) not initialized. \" +\r\n      \"Make sure firebase-client.js runs before script.js.\");\r\n  }\r\n  return auth;\r\n}\r\n\r\nfunction getFs() {\r\n  const fs = window.fbFs;\r\n  if (!fs) {\r\n    throw new Error(\"Firestore helpers (window.fbFs) not initialized. \" +\r\n      \"Make sure firebase-client.js sets window.fbFs.\");\r\n  }\r\n  return fs;\r\n}\r\n\r\nfunction escapeHtml(str) {\r\n  if (!str) return \"\";\r\n  return String(str).replace(/[&<>\"']/g, (s) => {\r\n    const map = {\r\n      \"&\": \"&amp;\",\r\n      \"<\": \"&lt;\",\r\n      \">\": \"&gt;\",\r\n      '\"': \"&quot;\",\r\n      \"'\": \"&#39;\"\r\n    };\r\n    return map[s] || s;\r\n  });\r\n}\r\n\r\n// ---------- Initial wiring ----------\r\n\r\nwindow.addEventListener(\"DOMContentLoaded\", () => {\r\n  console.log(\"script.js loaded\");\r\n\r\n  // If firebase already initialized, run immediately\r\n  if (window.fbDb && window.fbAuth && window.fbFs) {\r\n    try {\r\n      loadLeaderboard(\"weekly\");\r\n    } catch (e) {\r\n      console.error(\"loadLeaderboard immediate call failed:\", e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Otherwise wait for firebase-ready from firebase-client.js\r\n  const onReady = () => {\r\n    window.removeEventListener(\"firebase-ready\", onReady);\r\n    try {\r\n      loadLeaderboard(\"weekly\");\r\n    } catch (err) {\r\n      console.error(\"loadLeaderboard after firebase-ready failed:\", err);\r\n    }\r\n  };\r\n  window.addEventListener(\"firebase-ready\", onReady);\r\n});\r\n\r\n// ---------- LEADERBOARD ----------\r\n\r\nasync function loadLeaderboard(period = \"weekly\") {\r\n  console.log(\"loadLeaderboard started for period:\", period);\r\n\r\n  const leaderboardList = document.getElementById(\"leaderboard-list\");\r\n  const btnWeekly  = document.getElementById(\"btn-weekly\");\r\n  const btnMonthly = document.getElementById(\"btn-monthly\");\r\n  const btnAlltime = document.getElementById(\"btn-alltime\");\r\n\r\n  if (!leaderboardList) {\r\n    console.warn(\"No #leaderboard-list element found; aborting loadLeaderboard.\");\r\n    return;\r\n  }\r\n\r\n  // Active button styling\r\n  [btnWeekly, btnMonthly, btnAlltime].forEach(btn =>\r\n    btn?.classList.remove(\"active\")\r\n  );\r\n  if (period === \"weekly\")       btnWeekly?.classList.add(\"active\");\r\n  else if (period === \"monthly\") btnMonthly?.classList.add(\"active\");\r\n  else if (period === \"alltime\") btnAlltime?.classList.add(\"active\");\r\n\r\n  leaderboardList.innerHTML =\r\n    '<li style=\"text-align:center; color:#888;\">Loading...</li>';\r\n\r\n  try {\r\n    const db = getDb();\r\n    const { collection, query, where, orderBy, limit, getDocs, Timestamp } = getFs();\r\n\r\n    const leaderboardRef = collection(db, \"leaderboard\");\r\n    let q;\r\n    let fetchLimit = 10;\r\n\r\n    if (period === \"weekly\" || period === \"monthly\") {\r\n  const cutoff = new Date();\r\n  if (period === \"weekly\") cutoff.setDate(cutoff.getDate() - 7);\r\n  else                      cutoff.setMonth(cutoff.getMonth() - 1);\r\n\r\n  q = query(\r\n    leaderboardRef,\r\n    where(\"timestamp\", \">=\", Timestamp.fromDate(cutoff)),\r\n    orderBy(\"score\", \"desc\"),\r\n    orderBy(\"timestamp\", \"desc\"),\r\n    limit(10)\r\n  );\r\n\r\n    } else {\r\n      // all‑time\r\n      q = query(\r\n        leaderboardRef,\r\n        orderBy(\"score\", \"desc\"),\r\n        orderBy(\"timestamp\", \"desc\"),\r\n        limit(10)\r\n      );\r\n    }\r\n\r\n    const snapshot = await getDocs(q);\r\n\r\n    if (!snapshot || snapshot.empty) {\r\n      leaderboardList.innerHTML =\r\n        '<li style=\"text-align:center; color:#888;\">No scores yet</li>';\r\n      return;\r\n    }\r\n\r\n    const entries = [];\r\n    snapshot.forEach((docSnap) => {\r\n      const data = docSnap.data();\r\n      if (data) entries.push(data);\r\n    });\r\n\r\n    leaderboardList.innerHTML = \"\";\r\n    entries.forEach((data, index) => {\r\n      const li = document.createElement(\"li\");\r\n      li.className = \"leaderboard-row\";\r\n      li.style.display = \"flex\";\r\n      li.style.justifyContent = \"space-between\";\r\n      li.style.alignItems = \"center\";\r\n      li.style.padding = \"8px 12px\";\r\n      li.innerHTML = `\r\n        <span style=\"flex:1; text-align:left;\">${index + 1}. ${escapeHtml(\r\n          data.username || \"Anonymous\"\r\n        )}</span>\r\n        <span style=\"width:80px; text-align:right; font-weight:700;\">${Number(\r\n          data.score || 0\r\n        )}</span>\r\n      `;\r\n      leaderboardList.appendChild(li);\r\n    });\r\n\r\n    console.log(\"loadLeaderboard completed\");\r\n  } catch (error) {\r\n    console.error(\"Error loading leaderboard:\", error);\r\n    leaderboardList.innerHTML =\r\n      '<li style=\"text-align:center; color:#c00;\">Error loading leaderboard</li>';\r\n  }\r\n}\r\n\r\nwindow.loadLeaderboard = loadLeaderboard;\r\n\r\n// ---------- PLAYER STATS ----------\r\n\r\nasync function loadPlayerStats() {\r\n  let auth, db, fs;\r\n  try {\r\n    auth = getAuthInstance();\r\n    db   = getDb();\r\n    fs   = getFs();\r\n  } catch (e) {\r\n    console.error(\"Firebase not initialized for loadPlayerStats:\", e);\r\n    const userStatsStatus = document.getElementById(\"user-stats-status\");\r\n    if (userStatsStatus) {\r\n      userStatsStatus.textContent = \"Firebase not initialized.\";\r\n      userStatsStatus.style.display = \"block\";\r\n    }\r\n    return;\r\n  }\r\n\r\n  const { doc, getDoc } = fs;\r\n\r\n  const userStatsTitle  = document.getElementById(\"user-stats-title\");\r\n  const userStatsStatus = document.getElementById(\"user-stats-status\");\r\n  const userStatsList   = document.getElementById(\"user-stats-list\");\r\n  const userTotalScore  = document.getElementById(\"user-total-score\");\r\n\r\n  const user = auth.currentUser;\r\n\r\n  if (!user) {\r\n    if (userStatsTitle) userStatsTitle.textContent = \"Player Stats\";\r\n    if (userStatsStatus) {\r\n      userStatsStatus.textContent = \"Sign in to see your stats.\";\r\n      userStatsStatus.style.display = \"block\";\r\n    }\r\n    if (userStatsList)  userStatsList.innerHTML = \"\";\r\n    if (userTotalScore) userTotalScore.textContent = \"Total Score: 0\";\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // user doc\r\n    const userDocRef = doc(db, \"users\", user.uid);\r\n    const userDoc    = await getDoc(userDocRef);\r\n\r\n    let username = user.email || \"Player\";\r\n    if (userDoc && userDoc.exists()) {\r\n      const userData = userDoc.data();\r\n      username = userData.username || user.email || username;\r\n    }\r\n\r\n    if (userStatsTitle) {\r\n      userStatsTitle.textContent = `${username}'s Top Scores`;\r\n    }\r\n\r\n    // stats doc\r\n    const userStatsRef = doc(db, \"userStats\", user.uid);\r\n    const userStatsDoc = await getDoc(userStatsRef);\r\n\r\n    if (!userStatsDoc || !userStatsDoc.exists()) {\r\n      if (userStatsStatus) {\r\n        userStatsStatus.textContent = \"No games played yet.\";\r\n        userStatsStatus.style.display = \"block\";\r\n      }\r\n      if (userStatsList)  userStatsList.innerHTML = \"\";\r\n      if (userTotalScore) userTotalScore.textContent = \"Total Score: 0\";\r\n      return;\r\n    }\r\n\r\n    const statsData  = userStatsDoc.data();\r\n    const scores     = Array.isArray(statsData.scores) ? statsData.scores : [];\r\n    const totalScore = Number(statsData.totalScore || 0);\r\n\r\n    if (userStatsStatus) userStatsStatus.style.display = \"none\";\r\n\r\n    if (userStatsList) {\r\n      userStatsList.innerHTML = \"\";\r\n\r\n      if (scores.length === 0) {\r\n        const li = document.createElement(\"li\");\r\n        li.style.textAlign = \"center\";\r\n        li.style.color = \"#888\";\r\n        li.textContent = \"No scores yet\";\r\n        userStatsList.appendChild(li);\r\n      } else {\r\n        scores.forEach((scoreEntry, index) => {\r\n          const li = document.createElement(\"li\");\r\n          li.style.display = \"flex\";\r\n          li.style.justifyContent = \"space-between\";\r\n          li.style.alignItems = \"center\";\r\n          li.style.padding = \"6px 10px\";\r\n\r\n          const dateText = `${scoreEntry.date || \"\"} ${\r\n            scoreEntry.time || \"\"\r\n          }`.trim();\r\n\r\n          li.innerHTML = `\r\n            <span style=\"flex:1; text-align:left;\">${index + 1}. ${Number(\r\n            scoreEntry.score || 0\r\n          )}</span>\r\n            <span style=\"width:140px; text-align:right; font-size:11px; color:#666;\">${escapeHtml(\r\n              dateText\r\n            )}</span>\r\n          `;\r\n          userStatsList.appendChild(li);\r\n        });\r\n      }\r\n    }\r\n\r\n    if (userTotalScore) {\r\n      // ✅ FIX: Use the new gamesPlayed field from Firestore\r\n      const gamesPlayed = Number(statsData.gamesPlayed || scores.length);\r\n      const avgScore    = gamesPlayed > 0 ? totalScore / gamesPlayed : 0;\r\n      const avgDisplay  = avgScore.toFixed(2);\r\n\r\n      userTotalScore.innerHTML = `\r\n        <div style=\"display:flex; justify-content:space-between; align-items:center; gap:16px; font-weight:700;\">\r\n          <div style=\"flex:1; text-align:left;  font-size:14px;\">Games: ${gamesPlayed}</div>\r\n          <div style=\"flex:1; text-align:center; font-size:14px;\">Total Score: ${totalScore}</div>\r\n          <div style=\"flex:1; text-align:right; font-size:14px;\">Avg. Score: ${avgDisplay}</div>\r\n        </div>\r\n      `;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error loading player stats:\", error);\r\n    if (userStatsStatus) {\r\n      userStatsStatus.textContent = \"Error loading stats.\";\r\n      userStatsStatus.style.display = \"block\";\r\n    }\r\n  }\r\n}\r\n\r\nwindow.loadPlayerStats = loadPlayerStats;"],"names":["getDb","db","window","fbDb","Error","getFs","fs","fbFs","escapeHtml","str","String","replace","s","async","loadLeaderboard","period","console","log","leaderboardList","document","getElementById","btnWeekly","btnMonthly","btnAlltime","forEach","btn","classList","remove","add","innerHTML","collection","query","where","orderBy","limit","getDocs","Timestamp","leaderboardRef","q","cutoff","Date","setDate","getDate","setMonth","getMonth","fromDate","snapshot","empty","entries","docSnap","data","push","index","li","createElement","className","style","display","justifyContent","alignItems","padding","username","Number","score","appendChild","error","warn","addEventListener","fbAuth","e","onReady","removeEventListener","err","loadPlayerStats","auth","getAuthInstance","userStatsStatus","textContent","doc","getDoc","userStatsTitle","userStatsList","userTotalScore","user","currentUser","userDocRef","uid","userDoc","email","exists","userStatsRef","userStatsDoc","statsData","scores","Array","isArray","totalScore","length","textAlign","color","scoreEntry","dateText","date","time","trim","gamesPlayed","avgDisplay","toFixed"],"mappings":"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"}